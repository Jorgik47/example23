# Планирование реализации модуля обновления цен для сайта 77volt

## 1. Цели и назначение
- Реализовать PHP-модуль обновления цен для сайта на 1С-Битрикс.
- Обеспечить загрузку прайсов от производителей, валидацию данных и применение логики обновления/добавления товаров.

### Инструменты проекта
- Bitrix Framework(Bitrix UI (BX.Main UI))
- PHP
- PhpSpreadsheet (парсинг Excel)
- JSON API (обмен с внешними сервисами)

## 2. Размещение модуля
`77volt/local/modules/update_price.module` — базовый путь подключения модуля обновления цен и загрузки новых товаров.


## 3. Структура каталога модуля изменения цен
```
/local/modules/update_price.module/
│-- include.php                     # Точка входа модуля
│-- install/
│   │-- components/
│   │   └─ update_price/
│   │       └─ templates/.default/
│   │           └─ priceUpdate.php  # Вывод отчётов по обновлению
                └─ newProductAdd.php # Форма добавления товаров
│   ├─ index.php                    # Инсталлятор
│   └─ version.php                  # Версия модуля
│-- libs/
│   ├─ Models/
│   │   └─ ExcelSchema.php #Модель структуры эксель-файла
│   └─ Services/
│       ├─ PriceUpdaterService.php #сервис для обновления цен на товары
│       ├─ JsonExportService.php #Сервис экспорта в Json-файл
│       ├─ Validators.php #Сервис для валидации 
│       ├─ ExcelParserService.php # Сервис для проверки Excel-файла на нужные поля
        └─ NewProductService.php #Сервис для создания нового продукта
└─ lang/ru/install/index.php        # Локализация инсталлятора
```



## 4. Модели данных

# Важное примечание!!!!!!
## Таблица берется из Bitrix/Catalog/Model/Price
### a) PriceTable(Структура товара) 
| Поле | Тип | Описание |
|------|-----|----------|
| `ID` | INT | Код (ID) ценового предложения. |
| `PRODUCT_ID` | INT | Код товара или торгового предложения (ID элемента инфоблока). |
| `EXTRA_ID` | INT |Код (ID) типа наценки.|
| `CATALOG_GROUP_ID` | INT |	Код (ID) типа цен.|
| `PRICE` | Decimal(18,2) | Величина цены. |
| `CURRENCY` | Char(3) | Код валюты цены. |
| `TIMESTAMP_X` | Datetime | 	Время модификации записи. |
| `QUANTITY_FROM` | INT |Минимальное количество товара, на которое распространяется предложение. |
| `QUANTITY_TO` | INT |Максимальное количество товара, на которое распространяется предложение.|
| `TMP_ID` | Varchar(40) | Временный строковый идентификатор, используемый для служебных целей. |
| `PRICE_SCALE` | Decimal(26,12) | 	Цена в базовой валюте. Поле доступно только для чтения, пересчитывается автоматически |



### b) ProductTable (структура продукта)

# Важное примечание!!!!!!
## Таблица берется из Bitrix/Catalog/Model/Product

| Поле                  | Тип             | Описание                                                                 |
|-----------------------|-----------------|-------------------------------------------------------------------------|
| `ID`                  | Int             | Код (ID) продукта.                                                      |
| `QUANTITY`            | Double          | Количество товара на складе.                                            |
| `QUANTITY_TRACE`      | Char(1)         | Флаг "Включить количественный учет" (Y/N/D).                            |
| `WEIGHT`              | Double          | Вес единицы товара.                                                     |
| `TIMESTAMP_X`         | Datetime        | Дата и время модификации записи.                                        |
| `PRICE_TYPE`          | Char(1)         | Тип цены. Используется для организации подписок: <br>`S` - одноразовый   |
|                       |                 | платеж, <br>`R` - регулярные платежи, <br>`T` - пробная подписка.        |
| `RECUR_SCHEME_LENGTH` | Int             | Длина периода подписки.                                                 |
| `RECUR_SCHEME_TYPE`   | Char(1)         | Тип периода подписки: <br>`H` - час, <br>`D` - сутки, <br>`W` - неделя,  |
|                       |                 | <br>`M` - месяц, <br>`Q` - квартал, <br>`S` - полугодие, <br>`Y` - год.  |
| `TRIAL_PRICE_ID`      | Int             | Код (ID) товара, для которого данный товар является пробным.            |
| `WITHOUT_ORDER`       | Char(1)         | Флаг "Продление подписки без оформления заказа" (Y/N).                  |
| `VAT_ID`              | Int             | Идентификатор ставки НДС, привязанной к товару.                         |
| `VAT_INCLUDED`        | Char(1)         | Флаг "НДС включен в цену" (Y/N).                                        |
| `CAN_BUY_ZERO`        | Char(1)         | Флаг "Разрешить покупку при отсутствии товара" (Y/N/D).                 |
| `TMP_ID`              | Varchar(40)     | Временный строковый идентификатор, используемый для служебных целей.    |
| `PURCHASING_PRICE`    | Decimal(18,2)   | Закупочная цена.                                                        |
| `PURCHASING_CURRENCY` | Char(3)         | Валюта закупочной цены.                                                 |
| `BARCODE_MULTI`       | Char(1)         | Флаг определяет, имеет ли каждый экземпляр товара собственный штрихкод  |
|                       |                 | (Y/N).                                                                  |
| `QUANTITY_RESERVED`   | Double          | Зарезервированное количество.                                           |
| `SUBSCRIBE`           | Char(1)         | Флаг "Разрешить подписку при отсутствии товара" (Y/N/D).                |
| `WIDTH`               | Double          | Ширина товара (в мм).                                                   |
| `LENGTH`              | Double          | Длина товара (в мм).                                                    |
| `HEIGHT`              | Double          | Высота товара (в мм).                                                   |
| `MEASURE`             | Int             | Идентификатор единицы измерения.                                        |
| `TYPE`                | Int             | Тип товара.                                                             |
| `AVAILABLE`           | Char(1)         | Флаг доступности товара (Y/N).                                          |
| `BUNDLE`              | Char(1)         | Признак наличия набора у товара (Y/N).                                  |


 

### c) ExcelSchema (структура Excel-файла, создание новой таблицы для проверки файла)
## Новая ORM-таблица для валидации Excel-файла
| Поле                  | Тип                      | Описание           |
|-----------------------|---------------           |--------------------|
| `ID`                  | INT                      | Идентификатор схемы
| `MANUFACTURER`        | VARCHAR(50)              | Название производителя 
| `COLUMN_ARTICLE`      | VARCHAR(255)             | Колонка «Артикул» 
| `COLUMN_NAME`         | VARCHAR(255)             | Колонка «Наименование» 
| `COLUMN_PURCHASE`     | VARCHAR(255)             | Колонка «Закупочная цена» 
| `PURCHASING_CURRENCY` | CHAR(3)                  | Валюта закупочной цены 
| `COLUMN_MRC`          | VARCHAR(255)             | Колонка «МРЦ» 
| `COLUMN_WEIGHT`       | VARCHAR(255)             | Колонка с весом товара 
| `COLUMN_WIDTH`        | VARCHAR(255)             | Колонка с шириной товара 
| `COLUMN_LENGTH`       | VARCHAR(255)             | Колонка с длиной товара 
| `COLUMN_HEIGHT`       | VARCHAR(255)             | Колонка с высотой товара 
| `COLUMN_MEASURE`      | VARCHAR(255)             | Колонка с единицей измерения 
| `COLUMN_QUANTITY`     | VARCHAR(255)             | Колонка с количеством на складе 



## 5. Взаимодействие компонентов
1. **Загрузка и регистрация модуля**
   - `include.php` подключается при инициализации Bitrix, регистрирует классы из `libs/` и подтягивает локализацию из `lang/ru/install/index.php`.
   - `install/index.php` и `install/version.php` обеспечивают установку, обновление и совместимость модуля.

2. **Пользовательский интерфейс**
   - Компонент `install/components/update_price` рендерит шаблоны `.default/priceUpdate.php` и  `.default/newProductAdd.php`
   - UI может принимать два формата файла: 
      1. **В виде файла .xslx**
      2. **В виде ссылки на файл**
   - UI принимает Excel-файл (если была передана ссылка на файл, происходит его скачивание) передаёт его в `ExcelParserService`, для чтения и проверки правильности заполнения эксель-файла и запускает сценарии обновления или добавления товаров.


   - Шаблон `.default/priceUpdate.php` будет иметь простой интерфейс, состоящий из компонента выводящего списка Производителей, поля ввода, кнопок загрузки файла или ссылки файла, экспорта в JSON-файл, и обновления цен товаров на сайте. В случае отсутствия указанной позиции в базе, будет выдаваться предупреждение о том, что данного товара в базе нет и что нужно перейти на вкладку создания нового товара

   - Шаблон `.default/newProductAdd.php` будет иметь почти такой же интерфейс, состоящий из поля ввода, кнопок загрузки файла или ссылки файла, экспорта в JSON-файл, и добавления новых товаров на сайте и в базе. Также в этом модуле будет предусмотрена защита от добавления уже существующего товара, чтобы не было повторов позиций

3. **Парсинг и валидация данных**
   - `libs/Services/ExcelParserService.php` использует PhpSpreadsheet для чтения загруженного файла и приводит его к схеме `ExcelSchema.php`, парсит нужные колонки для обновления цен(артикул, закупка, МРЦ) и для создания нового товара(все колонки)
   - `libs/Services/Validators.php` проверяет наличие нужных колонок, типы и пустые значения до передачи данных дальше.

4. **Бизнес-логика обновления**
   - `libs/Services/PriceUpdaterService.php` и `libs/Services/NewProductService.php` работают с данными Excel, предварительно распарсенными `ExcelParserService`. Эти данные работают со встроенными моделями `Bitrix\Catalog\Model\Product` и `Bitrix\Catalog\Model\Price` для обновления цен или добавления товара в номенклатуру (если его нет в базе)

   - `libs/Services/PriceUpdaterService.php`, берет нужные колонки из данных Excel, проверяет есть ли товар в базе у выбранного производителя по артикулу и проводит обновление цен по такому расчету:
      - Для (ИЭК, КЭАЗ, КВТ, ЭРА) расчет цен происходит по МРЦ (как в 1С)
      - Для CHINT это +25% от закупки.

   - `libs/Services/NewProductService.php` проверяет на наличие товара в базе(дополнительная проверка), если нет, то эти товары с логистическими параметрами добавляются в базу данных
   
   
5. **Экспорт и интеграция**
   - `libs/Services/JsonExportService.php` формирует итоговый JSON после обновления или добавления данных и передаёт его в настроенный канал (REST API/архив в файловой системе) для дальнейшей синхронизации. Для работы с формированием JSON-файлов будет использоваться класс `\Bitrix\Main\Web\Json`


## 6. Стек технологий
PHP, HTML, CSS, JavaScript, JSON, Bitrix Framework

## 7. Срок реализации
Планируемый срок разработки и внедрения — 1 месяц.








