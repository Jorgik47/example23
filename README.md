# План реализации модуля обновления цен для сайта 77 volt



## Цель данной задачи:

1) Реализовать модуль обновления цен на языке PHP, который будет отвечать за загрузку прайсов от производителей и выполнять всю основную логику(бэкэнд):

	a) Проверку на валидацию файла excel

	b) Формирование отдельного json-файла

	c) Расчёт цен

	d) Обновление цен в базе данных

	e) Добавление новых товаров если в базе они отсутствуют.



2) Реализовать веб-интерфейс (панель управления обновлением)(фронтенд) который будет позволять:

	a) Выбрать производителя из списка

	b) Добавлять excel-файл через drag-and-drop или через ссылку

	c) Задать наименование и номер колонок

	d) Запустить процесс обновления цен



## Архитектура проекта:

Сам проект можно разбить на несколько модулей

```
price_update
│
├── index.php                 # Интерфейс загрузки
├── config/
│   ├── db.php                # Подключение к БД
│   └── settings.php          # Настройки
│
├── includes/
│   ├── router.php            # Обработка запросов
│   ├── excel_parser.php      # Парсер Excel
│   ├── validator.php         # Проверка данных
│   ├── json_exporter.php     # Экспорт в JSON
│   ├── price_updater.php     # Обновление цен
│   ├── new_products.php      # Добавление новых товаров
│   ├── models.php            # Модели данных
│   └── logs.php              # Логирование результата обновлений
│
├── uploads/                  # Временные файлы Excel
├── output/                   # Готовые JSON
```



## Этапы разработки:

### Создание интерфейса модуля.
	index.php - это файл, который отвечает за интерфейс загрузки.
	Планируется сделать модальное окно или же как отдельную страницу, в котором будут:

	Поле ввода загрузки файла

	Поля для настройки номеров и наименования колонок

	Кнопка «Обработать файл»



### Обработка excel-файла
	excel_parser.php - подмодуль, в котором мы будем обрабатывать excel-файл. Нужен, чтобы преобразовать данные из файла в массив.



### Валидация данных 
	validators.php - подмодуль, нужен для проверки наличия нужных колонок и правильности расчета цен



### Конвертация в JSON-файл
	json_exporter.php - после пройденных проверок, преобразуем новый json-файл для последующего обновления цен



### Обновление цен
	price_updater.php - загрузить полученный json-файл, сравнить артикулы из базы сайта и из json-файла, после чего происходит обновление



### Добавление новых товаров
	new_products.php - Позволяет добавлять новые товары, если их нет в базе

### Тестирование и отладка
	Тестирование кода на наличие ошибок и их исправление



## Модели данных

### Product(товар)

| Поле | Тип | Описание |
| --- | --- | --- |
| id | Int | Идентификатор |
| article | Varchar(50) | Артикул товара |
| name | Varchar(50) | Наименование товара |
| purchase_price | Decimal(10,2) | Закупочная цена |
| retail_price | Decimal(10,2) | Розничная цена |
| updated_at | DATETIME | Дата обновления товара |



### Manufacturer (производитель)

| Поле | Тип | Описание |
| --- | --- | --- |
| id | Int | Идентификатор |
| name | Varchar(50) | Наименование товара |
| percent_value | Decimal(5,2) | Процент для CHINT |
| url | Varchar(255) | Ссылка на прайс |
| update_url | Enum("MRC", "PERCENT") | Правило обновления(если компания не CHINT, то рассчитываем по МРЦ, а если да, то + 25% к МРЦ) |



### updateLog(логгирование обновлений)

| Поле | Тип | Описание |
| --- | --- | --- |
| id | Int | Идентификатор |
| manufacturer | Varchar(50) | Название производителя |
| file | Varchar(255) | Имя файла |
| total | int | Всего строк |
| updated | int | Обновлено(кол-во) |
| added | int | Добавлено |
| errors | Int | Ошибок |
| dateUpdate | Datetime | Время и дата обновления |



### ExcelSchema (структура эксель файла)

| Поле | Тип | Описание |
| --- | --- | --- |
| id | Int | Идентификатор |
| manufacturer_id | Varchar(50) | Название производителя |
| articul_name | Varchar(255) | Название колонки Артикул |
| column_arcticle | int | Номер колонки где хранится артикул |
| Name | Varchar(255) | Название колонки Наименование |
| column_name | int | Номер колонки где хранится наименование |
| purchase_price_name | varchar(255) | Название колонки закупочной цены |
| column_purchase_price | int | Номер колонки закупочной цены |
| mrc_price_name | varchar(255) | Название колонки МРЦ цены |
| column_mrc_price | int | Номер колонки МРЦ цены |
| Created_at | Datetime | Дата добавления файла |
| Updated_at | datetime | Дата последнего изменения |



### Модель JSON-файла, полученный после преобразования из excel-файла(как пример)

```json
{
 "manufacturer":string,
 "created_at": datetime, 
 "products": [ 
	{ 
	    "sku": string, 
	     "name": string, 	    
	     "purchase_price": float/null, 
	     "mrc_price": float/null, 
	     "retail_price": float
 	    }
] }
```

### Модель добавления нового товара(INewProduct)

| Поле | Тип | Описание |
| --- | --- | --- |
| id | Int | Идентификатор |
| name | String | Название товара |
| slug | string | url-адрес товара |
| article | string | Артикул товара |
| category | array | Категория товара |
| specifications | array | Характеристики товара |
| images | path: string | Фото товара |
| price | int/float | Цена товара |
| quantity | int | Количество товара |
| description | string | Описание товара |



### Модель  характеристики товара(specifications)

| Поле | Тип | Описание |
| --- | --- | --- |
| name | string | Название характеристики |
| value | string | Значение определённой характеристики |



### Модель характеристики категории(category)

| Поле | Тип | Описание |
| --- | --- | --- |
| Name | String | Название категории |
| Children | Array | Массив подкатегорий |
| Slug | Stirng | URL-адрес категории |



## Взаимодействие между компонентами

| Компонент | Использует | Назначение |
| --- | --- | --- |
| index.php | router.php | Отображает интерфейс загрузки Excel-файлов, выбор производителя, настройку колонок и запуск процесса обновления цен |
| config/db.php | Любую базу данных(Postgres SQL скорее всего) | Управляет подключением к базе данных |
| config/settings.php | - | Хранит настройки проекта, например пути к папкам, параметры загрузки |
| includes/router.php | includes/ | Маршрутизирует запросы к нужным модулям |
| includes/excel_parser.php | PhpSpreadsheet | Читает Excel-файл и формирует массив данных для последующей обработки |
| includes/validator.php | - | Проверяет корректность структуры и данных Excel-файла (наличие нужных колонок, пустые значения, типы данных) |
| includes/json_exporter.php | JSON API, output(папка, где будут создаваться json-файлы) | Преобразует валидированные данные в JSON-файл в папку output/, готовый для обновления БД |
| includes/price_updater.php | db.php, models.php | Обновляет цены товаров в базе данных согласно правилам (MRC или PERCENT) Осуществляет проверку есть ли этот товар в базе. Если нет, перекидывает на вкладку Создание товара |
| includes/new_products.php | db.php, models.php | Добавляет в базу новые товары, которых нет в текущей БД |
| includes/models.php | db.php | Определяет модели данных |
| includes/logs.php | update_logs | Сохраняет результаты обновления: количество обработанных товаров, добавленных, обновленных, ошибки, дату и пользователя |
| uploads/ | - | Хранит временные загруженные Excel-файлы |
| output/ | - | Хранит сформированные JSON-файлы после обработки Excel |



## Визуальная часть (фронтенд)
Рассматривается два варианта создания фронтенда для этого модуля:

1. Создание модального окна с двумя вкладками с последующей импортом на страницу
   - 1 - для обновления цен
   - 2 - для создания товара

2. Создание двух страниц
   - 1 страница - для обновления цен
   - 2 страница - для создания товара

## Стек технологий:
PHP, HTML, CSS, JavaScript, JSON



## Срок реализации - 1 месяц
